
@{
    ViewBag.Title = "Categorias";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<ol class="breadcrumb mb-4 mt-4">
    <li class="breadcrumb-item"><a href="index.html">Categorias</a></li>
    <li class="breadcrumb-item active">Categorias</li>
</ol>
<div class="card">
    <div class="card-header">
        <i class="fa-solid fa-layer-group"></i>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                <button type="button" class="btn btn-success" onclick="abrirModal()">Nueva Categoria</button>
            </div>
        </div>
        <hr /> @*Linea divisoria*@

        <table id="tCategoria" class="display cell-border" style="width:100%">
            @*Inicia la tabla*@
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th> </th> <!-- (Este es para los botones) -->
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table> @*Termina la tabla*@
    </div>
</div>

<div class="modal fade" id="FormModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        @*agregue "modal-xl" para que sea mas largo y se vea mas presentable*@
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel"> Categorias </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!---->
            <div class="modal-body">
                <input id="txtid" type="hidden" value="0" /> @*usuario en CERO para nuevo perfiles*@
            <form id="formCategoria">
                <div class="row g-2">
                    <div class="col-6">
                        <label for="lblIdCategoria" class="form-label">Id Categoria</label>
                        <input type="text" class="form-control" id="txtIdCategoria" style="background-color: #f0f0f0; border: 1px solid #ccc; color: #6c757d;" readonly />
                    </div>
                    <div class="col-sm-6">
                        <label for="lblTipo" class="form-label">Nombre Categoria</label>
                        <input type="text" class="form-control" id="txtTipo" name="txtTipo" />
                    </div>
                    <div class="col-sm-6">
                        <label for="lblEstado" class="form-label">Estado</label>
                        <select id="cbEstado" class="form-select">
                            <option selected>Selecciona una Opcion</option>
                            <option value="1">Activo</option>
                            <option value="0">Inactivo</option>
                        </select>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <div id="mensajeError" class="alert alert-danger" role="alert" style="display: none;">
                                Alerta!
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Guardar()">Guardar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
   var filaSeleccionada;
   var tabladata = $("#tCategoria").DataTable({
   responsive: true,
   ordering: false,
   "ajax": {
   url: '@Url.Action("ListarCategorias", "Mantenimientos")',
   type: "GET",
   dataType: "json"
        },
       "columns": [
           { "data": "IdCategoria" },
           { "data": "Tipo" },
           {
               "data": "Estado", "render": function (valor) {
                   if (valor) {
                       return '<span class="badge bg-success">Activo</span>'
                   } else {
                       return '<span class="badge bg-danger">Inactivo</span>'
                   }
               }
           },
           {
               "defaultContent":
                   '<button type="button" class="btn btn-outline-success btn-sm btn-editar"><i class="fas fa-marker"></i></button>' + ' ' +
                   '<button type="button" class="btn btn-outline-danger btn-sm sm-2 btn-eliminar"><i class="fas fa-trash"></i></button>',
               "orderable": false,
               "searchable": false,
               "width": "50px"
           }
       ],

 "language": {
    "url": "https://cdn.datatables.net/plug-ins/2.2.2/i18n/es-ES.json"
}
   });

        // Agregando método personalizado para regex
        $.validator.addMethod("letrasConEspacios", function (value, element) {
            return this.optional(element) || /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(value);
        }, "Ingrese solo letras evite caracteres especiales.");

        // Validación del formulario
        $("#formCategoria").validate({
            rules: {
                txtTipo: {
                    required: true,
                    letrasConEspacios: true
                },
                cbEstado: {
                    required: true
                }
            },
            messages: {
                txtTipo: "- Por favor ingrese un nombre de Categoria válido (Evita numeros)",
                cbEstado: "- Por favor seleccione un estado"
            },
            errorElement: "div",
            errorLabelContainer: ".alert-danger"
        }); //Terminamos toda la validacion

    //FUNCION PARA ABRIR MODAL
        function abrirModal(jsonData) {
            $("#txtIdCategoria").val("");
            $("#txtTipo").val("");
            $("#cbEstado").val(1);
            $("#mensajeError").hide();

            if (jsonData != null) {
                $("#txtIdCategoria").val(jsonData.IdCategoria);
                $("#txtTipo").val(jsonData.Tipo);
                $("#cbEstado").val(jsonData.Estado);
            }
            $("#FormModal").modal("show");
        }//termina abrirModal

        // Declarar variable global al inicio del script
        var filaSeleccionada = null;
        $("#tCategoria tbody").on("click", ".btn-editar", function () {
            filaSeleccionada = $(this).closest("tr");

            // Si es una fila 'child', obtener la real (la que tiene los datos)
            if (filaSeleccionada.hasClass("child")) {
                filaSeleccionada = filaSeleccionada.prev();
            }
            var data = tabladata.row(filaSeleccionada).data();
            abrirModal(data);
        });

        //boton eliminar
        $("#tCategoria tbody").on("click", ".btn-eliminar", function () {
            var categoriaSeleccionado = $(this).closest("tr")

            var data = tabladata.row(categoriaSeleccionado).data();
            //pagamos sweet alert
            swal({
                title: "Quieres eliminar el registro?",
                text: "No lo podras recuperar!",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn-danger",
                confirmButtonText: "Si,eliminalo!",
                closeOnConfirm: false
            },

            function () {
            jQuery.ajax({
              url: '@Url.Action("EliminarCategoria", "Mantenimientos")',
                type: "POST",
                data: JSON.stringify({ IdCat: data.IdCategoria}),
              dataType: "json",
              contentType: "application/json; charset=utf-8",
              success: function (data)
              {
                  if (data.resultado) {
                      tabladata.row(categoriaSeleccionado).remove().draw();
                      swal("Categoria Borrada","La categoria fue eliminado con exito","success");
                  } else {
                      swal("Registro no se puede eliminar",data.mensaje,"error");
                  }
              },
                      error: function (error) {
                          console.log(error);
                          $("#mensajeError").text("Ha ocurrido un error al procesar la solicitud.");
                          $("#mensajeError").show();
                }
            });
        });
        })

        function Guardar() {
            if (!$("#formCategoria").valid()) {
                return;
            }
            var Categoria = {
                IdCategoria: $("#txtIdCategoria").val(),
                Tipo: $("#txtTipo").val(),
                Estado: $("#cbEstado").val() == 1 ? true : false,
            };

            // Validar campos requeridos
            if (!Categoria.Tipo) {
                $("#mensajeError").text("Por favor completa todos los campos requeridos.");
                $("#mensajeError").show();
                return;
            }

            jQuery.ajax({
            url: '@Url.Action("GuardarCategoria", "Mantenimientos")',
            type: "POST",
            data: JSON.stringify({ obj:Categoria}),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
            $(".modal-body").LoadingOverlay("hide");
            if (Categoria.IdCategoria == 0) { // Nueva creación
                if (data.resultado != 0) {
                    Categoria.IdCategoria = data.resultado;
                    tabladata.row.add(Categoria).draw(false);
                    $("#FormModal").modal("hide"); // Cerrar modal al agregar
                } else {
                    $("#mensajeError").text(data.mensaje);
                    $("#mensajeError").show();
                }
            } else { // Modificación
                if (data.resultado) {
                    tabladata.row(filaSeleccionada).data(Categoria).draw(false);
                    $("#FormModal").modal("hide"); // Cerrar modal al modificar
                } else {
                    $("#mensajeError").text(data.mensaje);
                    $("#mensajeError").show();
                }
            }
        },
        error: function (error) {
            //console.log(error); // Agrega esto para depuración
            $(".modal-body").LoadingOverlay("hide")
            $("#mensajeError").text("Ha ocurrido un error al procesar la solicitud.");
            $("#mensajeError").show();
        },
        beforeSend: function () {
            $(".modal-body").LoadingOverlay("show", {
                imageResizeFactor: 2,
                text: "Cargando...",
                size: 14,
            })
        }
        });
    //$("#FormModal").modal("hide");
}
    </script>
} 